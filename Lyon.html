<!DOCTYPE html>
<html lang="en">
<head>
  <!-- Use correct character set. -->
  <meta charset="utf-8">
  <!-- Tell IE to use the latest, best version (or Chrome Frame if pre-IE11). -->
  <meta http-equiv="X-UA-Compatible" content="IE=Edge,chrome=1">
  <!-- Make the application on mobile take up the full browser screen and disable user scaling. -->
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, minimum-scale=1, user-scalable=no">
  <title>Lyon buildings demo</title>
  <script src="thirdparty/cesium-1.7.1/Cesium.js"></script>
  <script src="js/BboxLib.js"></script>
  <script src="js/WorkQueue.js"></script>
  <script src="js/TileProvider.js"></script>
  <style>
      @import url(thirdparty/cesium-1.7.1/Widgets/widgets.css);
      html, body, #cesiumContainer {
          width: 100%; height: 100%; margin: 0; padding: 0; overflow: hidden;
      }
  </style>
</head>
<body>
  <div id="cesiumContainer"></div>
  <script>

    //var viewer = new Cesium.Viewer('cesiumContainer', {
    //    baseLayerPicker : false,
    //    imageryProvider : new Cesium.OpenStreetMapImageryProvider({
    //      url : '//a.tile.openstreetmap.org/'
    //      })});

    var viewer = new Cesium.Viewer('cesiumContainer', {baseLayerPicker : false});

    // set the view of Lyon
    var extent = new Cesium.Rectangle.fromDegrees(4.848, 45.755, 4.852, 45.76);
    viewer.camera.viewRectangle(extent);

    var texture_dir = "../w/textures/"

    // terrain
    viewer.scene.globe.depthTestAgainstTerrain = true;
    var cesiumTerrainProviderMeshes = new Cesium.CesiumTerrainProvider({
        url : '//cesiumjs.org/stk-terrain/tilesets/world/tiles'
    });
    viewer.terrainProvider = cesiumTerrainProviderMeshes;

    // Tiler
    viewer.scene.primitives.add(new Cesium.QuadtreePrimitive({
        tileProvider : new WfsTileProvider(
                           'http://localhost/cgi-bin/tinyows', 
                           'tows:textured_citygml_lat_long', 
                           'http://localhost/w/textures',
                           0, 10000)
    }));

    // antialiasing please
    viewer.scene.fxaa = true;

    // If the mouse is over a feature, change its color to yellow
    var restoreApearance;
    var restorePrimitive;
    var picking = false;
    handler = new Cesium.ScreenSpaceEventHandler(viewer.scene.canvas);
    handler.setInputAction(function(movement) {
        if (picking) return;
        picking = true;
        var pickedObject = viewer.scene.pick(movement.endPosition);
        if (Cesium.defined(pickedObject) 
            && Cesium.defined(pickedObject.primitive) 
            && Cesium.defined(pickedObject.primitive.gid) ) {

            if (pickedObject.primitive != restorePrimitive){
                if (Cesium.defined(restorePrimitive)){
                    restorePrimitive.appearance = restoreApearance;
                }
                restorePrimitive = pickedObject.primitive;
                restoreApearance = pickedObject.primitive.appearance;

                //console.log(pickedObject);
                var mat = new Cesium.Material({
                    fabric : {
                        type : 'DiffuseMap',
                        components : {
                            diffuse : 'vec3(1.,1.,0)',
                            specular : '0.1',
                            alpha : '1.'
                        }
                    }
                });

                pickedObject.primitive.appearance = new Cesium.MaterialAppearance({
                            material : mat, 
                            faceForward : true
                          });
            }

        } else {
            if (Cesium.defined(restorePrimitive)){
                restorePrimitive.appearance = restoreApearance;
                restoreApearance = undefined;
                restorePrimitive = undefined
            }
        }
        picking = false;
    }, Cesium.ScreenSpaceEventType.MOUSE_MOVE);
  </script>
</body>
</html>
