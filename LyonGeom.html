<!DOCTYPE html>
<html lang="en">
<head>
  <!-- Use correct character set. -->
  <meta charset="utf-8">
  <!-- Tell IE to use the latest, best version (or Chrome Frame if pre-IE11). -->
  <meta http-equiv="X-UA-Compatible" content="IE=Edge,chrome=1">
  <!-- Make the application on mobile take up the full browser screen and disable user scaling. -->
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, minimum-scale=1, user-scalable=no">
  <title>Lyon buildings demo</title>
  <script src="thirdparty/earcut.js"></script>
  <script src="thirdparty/cesium-1.11/Cesium.js"></script>
  <script src="js/BboxLib.js"></script>
  <script src="js/WorkerPool.js"></script>
  <script src="js/TileProvider.js"></script>
  <script src="thirdparty/proj4-src.js"></script>
  <script src="js/proj4-srs.js"></script>
  <style>
      @import url(thirdparty/cesium-1.11/Widgets/widgets.css);
      html, body, #cesiumContainer {
          top: 0px;
          left: 0px;
          position: absolute;
          width: 100%; 
          height: 100%; 
          margin: 0; 
          padding: 0; 
          overflow: hidden;
          z-index: -1;
      }
      #uiMenu {
          border-radius:5px;
          padding: 10px;
          position:absolute;
          left: 20px;
          font-family: "Arial";
          z-index: 99999;
      }
  </style>
</head>
<body>
  <div id="cesiumContainer"></div>
  <div id="uiMenu">
    <button type="button" onclick="toggleThematic()">toggle thematic coloring</button> 
    <button type="button" onclick="toggleHighlight()">toggle highlight on mouseover</button> 
    <button type="button" onclick="toggleOsm()">toggle OSM background</button>
    <button type="button" onclick="saveStats()">save stats</button>
  </div>
  <br/><br/>
  <div id="info"></div>
  <script>

var viewer = new Cesium.Viewer('cesiumContainer'/*, {baseLayerPicker : false, scene3DOnly : true}*/);


var texture_dir = "../w/textures/"

// terrain
viewer.scene.globe.depthTestAgainstTerrain = true;
var cesiumTerrainProviderMeshes = new Cesium.CesiumTerrainProvider({
    url : '//cesiumjs.org/stk-terrain/tilesets/world/tiles'
});
viewer.terrainProvider = cesiumTerrainProviderMeshes;

// Tiler
var rectangle = Cesium.Rectangle.fromDegrees(4.770386,45.716615,4.899764,45.789917);
var tileProvider = new WfsTileProvider(
                       'http://ks29236.kimsufi.com/cgi-bin/tinyows',
                       'tows:lyongeom', 
                       'http://ks29236.kimsufi.com/cesium-buildings-data',
                       rectangle, 500, 3);
viewer.scene.primitives.add(new Cesium.QuadtreePrimitive({tileProvider : tileProvider}));

var cameraView = new Cesium.Rectangle.fromDegrees(4.848, 45.755, 4.852, 45.76);
viewer.camera.viewRectangle(cameraView);
viewer.camera.lookUp(0.5);

// Imagery
var provider = new Cesium.WebMapServiceImageryProvider({
    enablePickFeatures : false,
    url: 'https://download.data.grandlyon.com/wms/grandlyon',
    layers : 'PlanGuide_VueEnsemble_625cm_CC46'//'Ortho2009_vue_ensemble_16cm_CC46'
});
viewer.imageryLayers.addImageryProvider(provider);

function saveStats(){
    urlContent = "data:application/octet-stream," + encodeURIComponent(JSON.stringify(STATS));
    window.open(urlContent, 'Records');
}
 
viewer.scene.customPostProcess = new Cesium.CustomPostProcess(
    'uniform sampler2D u_tex;\n'+
    'uniform sampler2D u_normalTexture;\n'+
   // 'uniform sampler2D u_depthTexture;\n'+
    'uniform float u_width, u_height;\n'+
    'varying vec2 v_textureCoordinates;\n'+
    '\n'+
    'vec4 get_pixel(in vec2 coords, in float dx, in float dy) {\n'+
    ' return texture2D(u_normalTexture, coords + vec2(dx, dy));\n'+
    '}\n'+
    '\n'+
    '// returns pixel color\n'+
    'float IsEdge(in vec2 coords){\n'+
    '  float dxtex = 1.0 / u_width /*image width*/;\n'+
    '  float dytex = 1.0 / u_height /*image height*/;\n'+
    '  vec3 pix[9];\n'+
    '  float delta;\n'+
    '\n'+
    '  // read neighboring pixel intensities\n'+
    '  for (int i=-1; i<2; i++) {\n'+
    '   for(int j=-1; j<2; j++) {\n'+
    '    pix[(i+1)*3+j+1] = 2.0*(get_pixel(coords,float(i)*dxtex,\n'+
    '                                          float(j)*dytex).rgb - vec3(.5));\n'+
    '   }\n'+
    '  }\n'+
    '\n'+
    '  // average color differences around neighboring pixels\n'+
    '  delta =(length(cross(pix[1], pix[7]))+\n'+
    '          length(cross(pix[5], pix[3]))+\n'+
    '          length(cross(pix[0], pix[8]))+\n'+
    '          length(cross(pix[2], pix[6])))/4.0;\n'+
    '\n'+
    '  return delta /*> .1 ? 1.0 : 0.0 */;\n'+
    '}\n'+
    '\n'+
    'vec3 round(vec3 v){return floor(v+vec3(0.5));}\n' +
    'void main()\n'+
    '{\n'+
    '  //vec4 color = vec4(0.0,0.0,0.0,1.0);\n'+
    '  vec4 color = texture2D(u_tex, v_textureCoordinates);\n'+
    '  vec4 nrml = texture2D(u_normalTexture, v_textureCoordinates);\n'+
   // '  vec4 depth = texture2D(u_depthTexture, v_textureCoordinates);\n'+
    //'  color.rgb = 100.0*(2.0*(color.rgb - vec3(.5)) - round(2.0*(color.rgb - vec3(.5))*100.0)/100.0);\n'+
    //'  if ( 2.0*(color.rgb - vec3(.5)) == round(2.0*(color.rgb - vec3(.5))*100.0)/100.0 )\n'+
    '  color.rgb -= IsEdge(v_textureCoordinates)*vec3(1.0);\n'+
    '  color.a = 1.0;\n'+
    '  gl_FragColor = color;\n'+
    //'  gl_FragColor = nrml;\n'+
    '}\n'
    ,
    {
        u_width : function() { return viewer.canvas.clientWidth; },
        u_height : function() { return viewer.canvas.clientHeight; }
    });

var thematicOn = false;
    function toggleThematic(){
        if (!thematicOn){
            tileProvider.setColorFunction(function(properties){
                return (properties.tileX + properties.tileY) % 2 ? new Cesium.Color(0.5 + 0.25 * (properties.gid % 10) / 10.0,0.5 - 0.25 * (properties.gid % 10) / 10.0,0,1.0) :
                                                                   new Cesium.Color(0,0.5 + 0.25 * (properties.gid % 10) / 10.0,0.5 - 0.25 * (properties.gid % 10) / 10.0,1.0);
            });
            thematicOn = true;
        } else {
            tileProvider.setColorFunction(function(properties){
                return  new Cesium.Color(1.0,1.0,1.0,1.0);
            });
            thematicOn = false;
        }
    }

    var osmLayer;
    function toggleOsm(){
        if (!Cesium.defined(osmLayer)){
            osmLayer = viewer.scene.imageryLayers.addImageryProvider(
                new Cesium.OpenStreetMapImageryProvider({
                  url : '//a.tile.openstreetmap.org/'
                  }));
        } else {
            viewer.scene.imageryLayers.remove(osmLayer);
            osmLayer = undefined;
        }
    }

    var handler;
    var restore;
    var entity = new Cesium.Entity({name : 'Title to put in the infobox'});
    function toggleHighlight(){
        function restoreColor(){
            if(restore) {
                restore.attributes.color = Cesium.ColorGeometryInstanceAttribute.toValue(restore.primitive.properties[restore.id].color);
            }
        }
        if (!Cesium.defined(handler)){
            // If the mouse is over a feature, change its color to yellow
            var pickingInProgress = false;
            handler = new Cesium.ScreenSpaceEventHandler(viewer.scene.canvas);
            handler.setInputAction(function(movement) {
                if (pickingInProgress) return;
                pickingInProgress = true;
                var pickedObject = viewer.scene.pick(movement.endPosition);
                if (Cesium.defined(pickedObject) 
                    && Cesium.defined(pickedObject.primitive) 
                    && Cesium.defined(pickedObject.primitive.properties) ) {

                    if (!Cesium.defined(restore) || pickedObject.primitive != restore.primitive || pickedObject.primitive.id != restore.id){
                        restoreColor();
                        restore = {
                            primitive:pickedObject.primitive, 
                            id:pickedObject.id,
                            attributes:pickedObject.primitive.getGeometryInstanceAttributes(pickedObject.id)
                        };
                        entity.description = {
                            getValue : function() {
                                var properties = restore.primitive.properties[restore.id];
                                var string = "<table>";
                                for(var p in properties) {
                                  string += "<tr> <th>" + p + "</th><th>" + properties[p] + "</th></tr>";
                                }
                                string += "</table>"
                                return string;
                            }
                        };
                        viewer.selectedEntity = entity;

                        restore.attributes.color = Cesium.ColorGeometryInstanceAttribute.toValue(new Cesium.Color(1., 1., 0.));
                    }

                } else {
                    restoreColor();
                    viewer.selectedEntity = undefined;
                }
                pickingInProgress = undefined;
            }, Cesium.ScreenSpaceEventType.MOUSE_MOVE);
        } else {
            restoreColor();
            viewer.selectedEntity = noEntity;
            handler.destroy();
            handler = undefined;
        }
    }



  </script>
</body>
</html>
