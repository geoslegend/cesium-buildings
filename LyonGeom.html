<!DOCTYPE html>
<html lang="en">
<head>
  <!-- Use correct character set. -->
  <meta charset="utf-8">
  <!-- Tell IE to use the latest, best version (or Chrome Frame if pre-IE11). -->
  <meta http-equiv="X-UA-Compatible" content="IE=Edge,chrome=1">
  <!-- Make the application on mobile take up the full browser screen and disable user scaling. -->
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, minimum-scale=1, user-scalable=no">
  <title>Lyon buildings demo</title>
  <script src="thirdparty/earcut.js"></script>
  <script src="thirdparty/cesium/Build/Cesium/Cesium.js"></script>
  <script src="js/BboxLib.js"></script>
  <script src="js/WorkerPool.js"></script>
  <script src="js/TileProvider.js"></script>
  <script src="thirdparty/proj4-src.js"></script>
  <script src="js/proj4-srs.js"></script>
  <style>
      @import url(thirdparty/cesium/Build/Cesium/Widgets/widgets.css);
      html, body, #cesiumContainer {
          top: 0px;
          left: 0px;
          position: absolute;
          width: 100%; 
          height: 100%; 
          margin: 0; 
          padding: 0; 
          overflow: hidden;
          z-index: -1;
      }
      #uiMenu {
          border-radius:5px;
          padding: 10px;
          position:absolute;
          left: 20px;
          font-family: "Arial";
          z-index: 99999;
      }
  </style>
</head>
<body>
  <div id="cesiumContainer"></div>
  <div id="uiMenu">
    <button type="button" onclick="toggleThematic()">toggle thematic coloring</button> 
    <button type="button" onclick="toggleHighlight()">toggle highlight on mouseover</button> 
    <button type="button" onclick="toggleOsm()">toggle OSM background</button> 
  </div>
  <script>

var viewer = new Cesium.Viewer('cesiumContainer', {baseLayerPicker : false, scene3DOnly : true});


var texture_dir = "../w/textures/"

// terrain
viewer.scene.globe.depthTestAgainstTerrain = true;
var cesiumTerrainProviderMeshes = new Cesium.CesiumTerrainProvider({
    url : '//cesiumjs.org/stk-terrain/tilesets/world/tiles'
});
viewer.terrainProvider = cesiumTerrainProviderMeshes;

// Tiler
var rectangle = Cesium.Rectangle.fromDegrees(4.770386,45.716615,4.899764,45.789917);
var tileProvider = new WfsTileProvider(
                       'http://ks29236.kimsufi.com/cgi-bin/tinyows',
                       'tows:lyongeom', 
                       'http://ks29236.kimsufi.com/cesium-buildings-data',
                       rectangle, 500, 3);
viewer.scene.primitives.add(new Cesium.QuadtreePrimitive({tileProvider : tileProvider}));
var viewRect = new Cesium.Rectangle.fromDegrees(4.848, 45.755, 4.852, 45.76);
viewer.camera.viewRectangle(viewRect);
tileProvider.setMaterialFunction(function(properties){
    return new Cesium.Material({
        fabric : {
            type : 'DiffuseMap',
            components : {
                diffuse :  'vec3(1,1,1)',
                specular : '0.1'
            }
        }
    });
});
 
function setFilter(scene, filter, uniforms) {
    scene.customPostProcess = new Cesium.CustomPostProcess(filter, uniforms);
}
    viewer.scene.customPostProcess = new Cesium.CustomPostProcess(
        'uniform sampler2D u_texture;\n'+
        //'uniform sampler2D u_depth;\n'+
        'uniform float u_width, u_height;\n'+
        'varying vec2 v_textureCoordinates;\n'+
        '\n'+
        'vec4 get_pixel(in vec2 coords, in float dx, in float dy) {\n'+
        ' return texture2D(u_texture,coords + vec2(dx, dy));\n'+
        '}\n'+
        '\n'+
        '// returns pixel color\n'+
        'float IsEdge(in vec2 coords){\n'+
        '  float dxtex = 1.0 / u_width /*image width*/;\n'+
        '  float dytex = 1.0 / u_height /*image height*/;\n'+
        '  vec3 pix[9];\n'+
        '  float delta;\n'+
        '\n'+
        '  // read neighboring pixel intensities\n'+
        '  for (int i=-1; i<2; i++) {\n'+
        '   for(int j=-1; j<2; j++) {\n'+
        '    pix[(i+1)*3+j+1] = 2.0*(get_pixel(coords,float(i)*dxtex,\n'+
        '                                          float(j)*dytex).rgb - vec3(.5));\n'+
        '   }\n'+
        '  }\n'+
        '\n'+
        '  // average color differences around neighboring pixels\n'+
        '  delta =(length(cross(pix[1], pix[7]))+\n'+
        '          length(cross(pix[5], pix[3]))+\n'+
        '          length(cross(pix[0], pix[8]))+\n'+
        '          length(cross(pix[2], pix[6])))/4.0;\n'+
        '\n'+
        '  return delta > .1 ? 1.0 : 0.0 ;\n'+
        '}\n'+
        '\n'+
        'vec3 round(vec3 v){return floor(v+vec3(0.5));}\n' +
        'void main()\n'+
        '{\n'+
        '  //vec4 color = vec4(0.0,0.0,0.0,1.0);\n'+
        //'  vec4 depth = vec4(texture2D(u_texture, v_textureCoordinates));\n'+
        '  vec4 color = texture2D(u_texture, v_textureCoordinates);\n'+
        //'  color.rgb = 100.0*(2.0*(color.rgb - vec3(.5)) - round(2.0*(color.rgb - vec3(.5))*100.0)/100.0);\n'+
        //'  if ( 2.0*(color.rgb - vec3(.5)) == round(2.0*(color.rgb - vec3(.5))*100.0)/100.0 )\n'+
        '  color.rgb -= IsEdge(v_textureCoordinates)*vec3(1.0);\n'+
        '  gl_FragColor = color;\n'+
        //'  gl_FragColor = vec4(czm_unpackDepth(depth));\n'+
        '}\n'
        ,
        {
            u_width : function() { return viewer.canvas.clientWidth; },
            u_height : function() { return viewer.canvas.clientHeight; },
            u_prof : function() { return viewer.scene.context.depthTexture; }
        });
                    

var thematicOn = false;
    function toggleThematic(){
        if (!thematicOn){
            tileProvider.setMaterialFunction(function(properties){
                return new Cesium.Material({
                    fabric : {
                        type : 'DiffuseMap',
                        components : {
                            diffuse :  properties.gid%2 ? 'vec3(.7,.3,0)' : 'vec3(1,.5,0)',
                            specular : '0.1'
                        }
                    }
                });
            });
            thematicOn = true;
        } else {
            tileProvider.setMaterialFunction(function(properties){
                return new Cesium.Material({
                    fabric : {
                        type : 'DiffuseMap',
                        uniforms : {
                            image :  'http://localhost/w/textures'+'/'+properties.tex.url
                        }
                    }
                });
            });
            thematicOn = false;
        }
    }

    var osmLayer;
    function toggleOsm(){
        if (!Cesium.defined(osmLayer)){
            osmLayer = viewer.scene.imageryLayers.addImageryProvider(
                new Cesium.OpenStreetMapImageryProvider({
                  url : '//a.tile.openstreetmap.org/'
                  }));
        } else {
            viewer.scene.imageryLayers.remove(osmLayer);
            osmLayer = undefined;
        }
    }

    var handler;
    function toggleHighlight(){
        var restore;
        if (!Cesium.defined(handler)){
            // If the mouse is over a feature, change its color to yellow
            var pickingInProgress = false;
            handler = new Cesium.ScreenSpaceEventHandler(viewer.scene.canvas);
            handler.setInputAction(function(movement) {
                if (pickingInProgress) return;
                pickingInProgress = true;
                var pickedObject = viewer.scene.pick(movement.endPosition);
                if (Cesium.defined(pickedObject) 
                    && Cesium.defined(pickedObject.primitive) 
                    && Cesium.defined(pickedObject.primitive.properties) ) {

                    if (!Cesium.defined(restore) || pickedObject.primitive != restore.primitive){
                        if (Cesium.defined(restore)){
                            restore.primitive.appearance = restore.appearance;
                        }
                        restore = {
                            primitive:pickedObject.primitive, 
                            appearance:pickedObject.primitive.appearance
                        };

                        var mat = new Cesium.Material({
                            fabric : {
                                type : 'DiffuseMap',
                                components : {
                                    diffuse : 'vec3(1.,1.,0)',
                                    alpha : '1.'
                                }
                            }
                        });

                        pickedObject.primitive.appearance = new Cesium.MaterialAppearance({
                                    material : mat, 
                                    faceForward : true
                                  });
                    }

                } else {
                    if (Cesium.defined(restore)){
                        restore.primitive.appearance = restore.appearance;
                        restore = undefined;
                    }
                }
                pickingInProgress = false;
            }, Cesium.ScreenSpaceEventType.MOUSE_MOVE);
        } else {
            if (Cesium.defined(restore)){
                restore.primitive.appearance = restore.appearance;
                restoreApearance = undefined;
            }
            handler.destroy();
            handler = undefined;
        }
        }
/*
var viewer = new Cesium.Viewer('cesiumContainer');
var extent = new Cesium.Rectangle.fromDegrees(4.833447,45.767639, 4.865213, 45.782010);
    viewer.camera.viewRectangle(extent);

var scene = viewer.scene;


// triangle tile
//var pt1local = new Cesium.Cartesian3(-1370.3492, 1988.8350, 0);
//var pt2local = new Cesium.Cartesian3(-1383.0728, 2532.7252, 0);
//var pt3local = new Cesium.Cartesian3(-1806.0040, 1978.6626, 0);
var pt1local = new Cesium.Cartesian3(-5177187.0659, 1844583.4299, 0);
var pt2local = new Cesium.Cartesian3(-5177199.7895, 1845127.3201, 0);
var pt3local = new Cesium.Cartesian3(-5177622.7207, 1844573.2575, 0);

var pt1cart = new Cesium.Cartesian3.fromDegrees(4.859421, 45.779551, 0);
var pt2cart = new Cesium.Cartesian3.fromDegrees(4.866417, 45.779551, 0);
var pt3cart = new Cesium.Cartesian3.fromDegrees(4.859421, 45.783472, 0);

// translation lambert -> lambert originie en pt1
var t0 = new Cesium.Cartesian3(5177187.0659, -1844583.4299, 0);

// définition de la transformation
var t = new Cesium.Cartesian3.fromDegrees(4.859421,45.779551,viewer.ellipsoid);
//Cesium.Cartesian3.add(t0,t,t);

//var m = Cesium.Matrix4.fromRotationTranslation(r,t);
var m = Cesium.Matrix4.fromTranslation(t);


var u = new Cesium.Cartesian3();
var v = new Cesium.Cartesian3();
var w = new Cesium.Cartesian3();
Cesium.Cartesian3.subtract(pt2local, pt1local, u);
Cesium.Cartesian3.subtract(pt3local, pt1local, v);
Cesium.Cartesian3.cross(u,v,w);

var up = new Cesium.Cartesian3();
var vp = new Cesium.Cartesian3();
var wp = new Cesium.Cartesian3();
Cesium.Cartesian3.subtract(pt2cart, pt1cart, up);
Cesium.Cartesian3.subtract(pt3cart, pt1cart, vp);
Cesium.Cartesian3.cross(up,vp,wp);

var U = new Cesium.Matrix3(u.x,v.x,w.x,
                          u.y,v.y,w.y,
                          u.z,v.z,w.z);

var Up = new Cesium.Matrix3(up.x,vp.x,wp.x,
                          up.y,vp.y,wp.y,
                          up.z,vp.z,wp.z);

var Uinv = new Cesium.Matrix3();
Cesium.Matrix3.inverse(U, Uinv);

var M = new Cesium.Matrix3();
Cesium.Matrix3.multiply(Up, Uinv, M);

Cesium.Matrix4.multiplyByMatrix3(m, M, m);

var M2 = new Cesium.Matrix4();
Cesium.Matrix4.fromTranslation(t0, M2);
Cesium.Matrix4.multiply(m, M2, m);


// tests

// points triangle
var pt1localToCart = new Cesium.Cartesian3();
var pt2localToCart = new Cesium.Cartesian3();
var pt3localToCart = new Cesium.Cartesian3();

Cesium.Matrix4.multiplyByPoint(m, pt1local, pt1localToCart);
Cesium.Matrix4.multiplyByPoint(m, pt2local, pt2localToCart);
Cesium.Matrix4.multiplyByPoint(m, pt3local, pt3localToCart);


viewer.entities.add({
        position : pt1localToCart,
        point : {
            show : true, // default
            color : Cesium.Color.SKYBLUE, // default: WHITE
            pixelSize : 10 // default: 1
        }
    });
viewer.entities.add({
        position : pt2localToCart,
        point : {
            show : true, // default
            color : Cesium.Color.SKYBLUE, // default: WHITE
            pixelSize : 10 // default: 1
        }
    });
viewer.entities.add({
        position : pt3localToCart,
        point : {
            show : true, // default
            color : Cesium.Color.SKYBLUE, // default: WHITE
            pixelSize : 10 // default: 1
        }
    });
viewer.entities.add({
        position : pt1cart,
        point : {
            show : true, // default
            color : Cesium.Color.YELLOW, // default: WHITE
            pixelSize : 10 // default: 1
        }
    });
viewer.entities.add({
        position : pt2cart,
        point : {
            show : true, // default
            color : Cesium.Color.YELLOW, // default: WHITE
            pixelSize : 10 // default: 1
        }
    });
viewer.entities.add({
        position : pt3cart,
        point : {
            show : true, // default
            color : Cesium.Color.YELLOW, // default: WHITE
            pixelSize : 10 // default: 1
        }
    });

console.log("Distance p1 : " + Cesium.Cartesian3.distance(pt1localToCart, pt1cart));
console.log("Distance p2 : " + Cesium.Cartesian3.distance(pt2localToCart, pt2cart));
console.log("Distance p3 : " + Cesium.Cartesian3.distance(pt3localToCart, pt3cart));


// points côté triangle
var pt1ct = new Cesium.Cartesian3(-5177387.0659, 1844583.4299, 0);
var pt2ct = new Cesium.Cartesian3(-5177187.0659, 1844783.4299, 0);
var pt3ct = new Cesium.Cartesian3(-5177411.1051, 1844850.2888, 0);

var pt1ctcart = new Cesium.Cartesian3.fromDegrees(4.85948103826,45.7813500683, 0);
var pt2ctcart = new Cesium.Cartesian3.fromDegrees(4.86199217191,45.7795089633, 0);
var pt3ctcart = new Cesium.Cartesian3.fromDegrees(4.86291907815,45.7815102048, 0);

Cesium.Matrix4.multiplyByPoint(m, pt1ct, pt1ct);
Cesium.Matrix4.multiplyByPoint(m, pt2ct, pt2ct);
Cesium.Matrix4.multiplyByPoint(m, pt3ct, pt3ct);


viewer.entities.add({
        position : pt1ctcart,
        point : {
            show : true, // default
            color : Cesium.Color.BLUEVIOLET, // default: WHITE
            pixelSize : 10 // default: 1
        }
    });
viewer.entities.add({
        position : pt2ctcart,
        point : {
            show : true, // default
            color : Cesium.Color.BLUEVIOLET, // default: WHITE
            pixelSize : 10 // default: 1
        }
    });
viewer.entities.add({
        position : pt3ctcart,
        point : {
            show : true, // default
            color : Cesium.Color.BLUEVIOLET, // default: WHITE
            pixelSize : 10 // default: 1
        }
    });


viewer.entities.add({
        position : pt1ct,
        point : {
            show : true, // default
            color : Cesium.Color.RED, // default: WHITE
            pixelSize : 10 // default: 1
        }
    });
viewer.entities.add({
        position : pt2ct,
        point : {
            show : true, // default
            color : Cesium.Color.RED, // default: WHITE
            pixelSize : 10 // default: 1
        }
    });
viewer.entities.add({
        position : pt3ct,
        point : {
            show : true, // default
            color : Cesium.Color.RED, // default: WHITE
            pixelSize : 10 // default: 1
        }
    });


console.log("Distance pc1 : " + Cesium.Cartesian3.distance(pt1ct, pt1ctcart));
console.log("Distance pc2 : " + Cesium.Cartesian3.distance(pt2ct, pt2ctcart));
console.log("Distance pc3 : " + Cesium.Cartesian3.distance(pt3ct, pt3ctcart));

var pt1m = new Cesium.Cartesian3(-5177387.0659, 1844783.4299, 0);
var pt1mcart = new Cesium.Cartesian3.fromDegrees(4.86205229285,45.7813080302, 0);
Cesium.Matrix4.multiplyByPoint(m, pt1m, pt1m);

console.log("Distance pm1 : " + Cesium.Cartesian3.distance(pt1m, pt1mcart));

viewer.entities.add({
        position : pt1m,
        point : {
            show : true, // default
            color : Cesium.Color.BROWN, // default: WHITE
            pixelSize : 10 // default: 1
        }
    });
viewer.entities.add({
        position : pt1mcart,
        point : {
            show : true, // default
            color : Cesium.Color.CORAL, // default: WHITE
            pixelSize : 10 // default: 1
        }
    }); 
*/
  </script>
</body>
</html>
