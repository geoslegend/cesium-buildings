<!DOCTYPE html>
<html lang="en">
<head>
  <!-- Use correct character set. -->
  <meta charset="utf-8">
  <!-- Tell IE to use the latest, best version (or Chrome Frame if pre-IE11). -->
  <meta http-equiv="X-UA-Compatible" content="IE=Edge,chrome=1">
  <!-- Make the application on mobile take up the full browser screen and disable user scaling. -->
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, minimum-scale=1, user-scalable=no">
  <title>Lyon buildings demo</title>
  <script src="thirdparty/earcut.js"></script>
  <script src="thirdparty/cesium-1.11/Cesium.js"></script>
  <script src="js/BboxLib.js"></script>
  <script src="js/WorkerPool.js"></script>
  <script src="js/TileProvider.js"></script>
  <script src="thirdparty/proj4-src.js"></script>
  <script src="js/proj4-srs.js"></script>
  <style>
      @import url(thirdparty/cesium-1.11/Widgets/widgets.css);
      html, body, #cesiumContainer {
          top: 0px;
          left: 0px;
          position: absolute;
          width: 100%; 
          height: 100%; 
          margin: 0; 
          padding: 0; 
          overflow: hidden;
          z-index: -1;
      }
      #uiMenu {
          border-radius:5px;
          padding: 10px;
          position:absolute;
          left: 20px;
          font-family: "Arial";
          z-index: 99999;
      }
  </style>
</head>
<body>
  <div id="cesiumContainer"></div>
  <div id="uiMenu">
    <button type="button" onclick="toggleThematic()">toggle thematic coloring</button> 
    <button type="button" onclick="toggleHighlight()">toggle highlight on mouseover</button> 
    <button type="button" onclick="toggleOsm()">toggle OSM background</button>
    <button type="button" onclick="saveStats()">save stats</button>
  </div>
  <br/><br/>
  <div id="info"></div>
  <script>

var viewer = new Cesium.Viewer('cesiumContainer', {baseLayerPicker : false, scene3DOnly : true});


var texture_dir = "../w/textures/"

// terrain
viewer.scene.globe.depthTestAgainstTerrain = true;
var cesiumTerrainProviderMeshes = new Cesium.CesiumTerrainProvider({
    url : '//cesiumjs.org/stk-terrain/tilesets/world/tiles'
});
viewer.terrainProvider = cesiumTerrainProviderMeshes;

// Tiler
var rectangle = Cesium.Rectangle.fromDegrees(4.770386,45.716615,4.899764,45.789917);
var tileProvider = new WfsTileProvider(
                       'http://ks29236.kimsufi.com/cgi-bin/tinyows',
                       'tows:lyongeom', 
                       'http://ks29236.kimsufi.com/cesium-buildings-data',
                       rectangle, 500, 3);
viewer.scene.primitives.add(new Cesium.QuadtreePrimitive({tileProvider : tileProvider}));
var cameraView = new Cesium.Rectangle.fromDegrees(4.848, 45.755, 4.852, 45.76);
viewer.camera.viewRectangle(cameraView);
viewer.camera.lookUp(0.5);
tileProvider.setMaterialFunction(function(properties){
    return new Cesium.Material({
        fabric : {
            type : 'DiffuseMap',
            components : {
                diffuse :  'vec3(1,1,1)',
                specular : '0.1'
            }
        }
    });
});

// Imagery
var provider = new Cesium.WebMapServiceImageryProvider({
    url: 'https://download.data.grandlyon.com/wms/grandlyon',
    layers : 'PlanGuide_VueEnsemble_625cm_CC46'//'Ortho2009_vue_ensemble_16cm_CC46'
});
viewer.imageryLayers.addImageryProvider(provider);

function saveStats(){
    urlContent = "data:application/octet-stream," + encodeURIComponent(JSON.stringify(STATS));
    window.open(urlContent, 'Records');
}
 
var thematicOn = false;
    function toggleThematic(){
        if (!thematicOn){
            tileProvider.setMaterialFunction(function(properties){
                return new Cesium.Material({
                    fabric : {
                        type : 'DiffuseMap',
                        components : {
                            diffuse : (properties.tileX + properties.tileY) % 2 ? 'vec3(0.5,0.5,0)' : 'vec3(0,0.5,0.5)',
                            specular : '0.1'
                        }
                    }
                });
            });
            thematicOn = true;
        } else {
            tileProvider.setMaterialFunction(function(properties){
                return new Cesium.Material({
                    fabric : {
                        type : 'DiffuseMap',
                        uniforms : {
                            components : {
                                diffuse :  'vec3(1,1,1)',
                                specular : '0.1'
                            }
                        }
                    }
                });
            });
            thematicOn = false;
        }
    }

    var osmLayer;
    function toggleOsm(){
        if (!Cesium.defined(osmLayer)){
            osmLayer = viewer.scene.imageryLayers.addImageryProvider(
                new Cesium.OpenStreetMapImageryProvider({
                  url : '//a.tile.openstreetmap.org/'
                  }));
        } else {
            viewer.scene.imageryLayers.remove(osmLayer);
            osmLayer = undefined;
        }
    }

    var handler;
    function toggleHighlight(){
        var restore;
        if (!Cesium.defined(handler)){
            // If the mouse is over a feature, change its color to yellow
            var pickingInProgress = false;
            handler = new Cesium.ScreenSpaceEventHandler(viewer.scene.canvas);
            handler.setInputAction(function(movement) {
                if (pickingInProgress) return;
                pickingInProgress = true;
                var pickedObject = viewer.scene.pick(movement.endPosition);
                if (Cesium.defined(pickedObject) 
                    && Cesium.defined(pickedObject.primitive) 
                    && Cesium.defined(pickedObject.primitive.properties) ) {

                    if (!Cesium.defined(restore) || pickedObject.primitive != restore.primitive){
                        if (Cesium.defined(restore)){
                            restore.primitive.appearance = restore.appearance;
                        }
                        restore = {
                            primitive:pickedObject.primitive, 
                            appearance:pickedObject.primitive.appearance
                        };

                        var mat = new Cesium.Material({
                            fabric : {
                                type : 'DiffuseMap',
                                components : {
                                    diffuse : 'vec3(1.,1.,0)',
                                    alpha : '1.'
                                }
                            }
                        });

                        pickedObject.primitive.appearance = new Cesium.MaterialAppearance({
                                    material : mat, 
                                    faceForward : true
                                  });
                    }

                } else {
                    if (Cesium.defined(restore)){
                        restore.primitive.appearance = restore.appearance;
                        restore = undefined;
                    }
                }
                pickingInProgress = false;
            }, Cesium.ScreenSpaceEventType.MOUSE_MOVE);
        } else {
            if (Cesium.defined(restore)){
                restore.primitive.appearance = restore.appearance;
                restoreApearance = undefined;
            }
            handler.destroy();
            handler = undefined;
        }
        }

  </script>
</body>
</html>
